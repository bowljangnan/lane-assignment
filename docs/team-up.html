version: v1.0.1 <br><br>
<title>ë³¼ì¥ë‚œ íŒ€ ë‚˜ëˆ„ê¸°</title>

<span style="font-size:20px;"><b> - ë³¼ì¥ë‚œ ì „ì²´ ì¸ì› - </b></span><br>
<span style="font-size:15px;color:red"><b>* ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤</b></span><br><br>
<div id="member-div">

</div>
<br><br><br>

<span style="font-size:20px;"><b> - ì •ëª¨ ì°¸ê°€ ì¸ì›: <span id="participant-count-span" style="font-size:20px;color:red">0</span>ëª… - </b></span><br>
<span style="font-size:15px;color:red"><b>* ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì°¸ê°€ì ëª©ë¡ì— ì œê±°ë©ë‹ˆë‹¤</b></span><br><br>
<button style="width:200px;height:50px;font-size:20px;" onclick="clearParticipant()">ì°¸ì—¬ ì¸ì› ì „ì²´ ì‚­ì œ</button><br><br>
<div id="participant-div">

</div>
<br>
<br>
<span style="font-size:20px;"><b> ---------------------------------------------------------- </b></span><br>
<div>
    <span style="width:200px;height:50px;font-size:20px;">
        <select id="team-count-select" style="width:100px;height:50px;font-size:25px;align-content: center">
            <option selected>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
        </select> ê°œ íŒ€ ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
    </span> <br><br>
    <button style="width:200px;height:50px;font-size:20px;" onclick="divideTeam()">íŒ€ ë‚˜ëˆ„ê¸° ì‹¤í–‰</button>
</div>

<br>
<div id="divide-team-div" style="font-size:15px">
</div>

<br><br>
<span style="font-size:20px;"><b> - ì‹œë“œ ë°°ì • - </b></span><br><br>
<div id="group-div">

</div>

<br><br>
<span style="font-size:20px;"><b> - íŒ€ ë°°ì • - </b></span><br><br>
<div id="team-div">
    <table id="team-table">
        <thead><td></td> <td>íŒ€ í•©ì‚°</td> <td>íŒ€ì›</td> <td>ì¶”ì²œí•¸ë”” <button onclick="guideRecommendHandicapScore()">ì¶”ì²œ í•¸ë””ë€?</button></td></thead>
    </table>

</div>
<script>
  window.onload = initialize()

  const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/average?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'
  const memberList = []
  let groups = []
  const participantMap = new Map();
  const topSeedScore = 180

  function initialize() {
    initializeMember();
  }

  function initializeMember() {


    fetch(spreadSheetUrl, null)
      .then((response) => response.json())
      .then((data) => initializeMemberMap(data["values"]))
      .catch((error) => console.log("error:", error));
  }

  function initializeMemberMap(values) {
    for (let index = 0; index < values.length; index++) {
      let name = getNohyooKingValue(values[index][0])
      memberList.push({ "id": index, "name" : name, "score" : parseInt(values[index][1]), "handicap": 0 })
    }
    initializeMemberView()
  }

  function getNohyooKingValue(name) {
    return name === "ë…¸ìœ í•œ" ? "ë…¸ìœ ğŸ‘‘" :  name
  }

  function initializeMemberView() {
    const memberDiv = document.getElementById("member-div");

    let index = 0
    for (const member of memberList) {
      memberDiv.innerHTML += getMemberButtonString(member)
      if ((index+1) % 8 === 0) {
        memberDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function getMemberButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="participateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getParticipateButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="removeParticipateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getMemberNameString(member) {
    return member.name + '(' + member.score + ')';
  }

  function participateMember(memberId) {
    participantMap.set(parseInt(memberId), memberList[memberId])
    updateParticipantView()
  }

  function removeParticipateMember(memberId) {
    participantMap.delete(parseInt(memberId))
    updateParticipantView()
  }

  function clearParticipant() {
    participantMap.clear();
    updateParticipantView()
  }

  function updateParticipantView() {
    const participantDiv = document.getElementById("participant-div");
    const participantCountDiv = document.getElementById("participant-count-span");

    participantDiv.innerHTML = ''

    let index = 0
    let keys = getKeys()

    participantCountDiv.innerText = '' + keys.length

    for (const key of keys) {
      const participant = participantMap.get(key)

      participantDiv.innerHTML += getParticipateButtonString(participant)
      if ((index+1) % 8 === 0) {
        participantDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function divideTeam() {
    const teamCountSelect = document.getElementById('team-count-select');
    const teamCount = parseInt(teamCountSelect.options[teamCountSelect.selectedIndex].value);
    divideGroupAndTeam(teamCount)
  }

  function divideGroupAndTeam(teamCount) {
    let keys = getKeys()
    groups = []

    for (let keyIndex = 0; keyIndex < keys.length; keyIndex += teamCount) {
      let group = []
      for (let groupCount = 1; groupCount <= teamCount; groupCount++) {
        const participant = participantMap.get(keys[keyIndex+groupCount-1])
        if (participant === undefined) {
          break
        }
        group.push(participant)
      }

      calculateHandicap(group)
        .then(() => groups.push(group))
        .then(() => {
          const groupDiv = document.getElementById("group-div");
          groupDiv.innerHTML = ''

          let groupIndex = 1
          for (const group of groups) {
            groupDiv.innerHTML += getSeedString(groupIndex, group)
            groupIndex++
          }
        })
        .then(() => divideRandomTeam(teamCount))
    }
  }

  function getSeedString(seedNumber, group) {
    let str = ''
    str += seedNumber++ + ' ì‹œë“œ: '
    for (const participant of group) {
      str += participant.name + ' '
    }
    str += '<br>'

    return str
  }

  function calculateHandicap(group) {
    // í•¸ë”” ì¡°ì •

    // ëª¨ë“  ê·¸ë£¹ì´ 180ì  ì´ìƒì¸ ê²½ìš° í•¸ë”” ì¡°ì • ì—†ìŒ
    if (isAllTopSeedMember(group)) {
      return new Promise(function(resolve) { resolve() });
    }

    const averageOfGroup = sumOfTeamScore(group) / group.length

    for (let participant of group) {
      const diff = participant.score - averageOfGroup
      let handicap = 0
      if (Math.abs(diff) > 10) {
        handicap = Math.round(diff / 10) * 10 * -1
      }

      participant.handicap = handicap
    }

    return new Promise(function(resolve) { resolve() });
  }

  function isAllTopSeedMember(group) {
    for (let participant of group) {
      if (participant.score < topSeedScore) {
        return false;
      }
    }
    return true;
  }

  function divideRandomTeam(teamCount) {
    let teams = []

    for (const group of groups) {
      shuffle(group);
    }

    for (let count = 0; count < teamCount; count++) {
      let team = []

      for (const group of groups) {
        const averageOfGroup = Math.round((sumOfTeamScore(group) / group.length) / 10) * 10;

        let participant = group[count]
        if (participant === undefined) {
          participant = { "name" : "ê°€ìƒìœ ì €", "score" : 0, "handicap": averageOfGroup }
        }
        team.push(participant)
      }
      teams.push(team)
    }

    const teamTable = document.getElementById("team-table");
    const totalRow = teamTable.getElementsByTagName("tr").length
    for (let index = 1; index < totalRow; index++) {
      teamTable.deleteRow(1)
    }

    let teamIndex = 1
    for (const team of teams) {
      const newRow = teamTable.insertRow(teamIndex)
      newRow.insertCell(0).innerHTML = teamIndex + 'íŒ€'
      newRow.insertCell(1).innerHTML = sumOfTeamScore(team) + 'ì '
      const participantCell = newRow.insertCell(2)
      for (const participant of team) {
        participantCell.innerHTML += participant.name + '(' + getHandicapScoreString(participant.handicap) + ') '
      }
      newRow.insertCell(3).innerHTML = getHandicapScoreString(sumOfHandicap(team)) + 'ì '

      teamIndex++
    }
  }

  function getHandicapScoreString(score) {
    if (score > 0) {
      return '+' +  score
    } else {
      return '' +  score
    }
  }

  function sumOfHandicap(team) {
    let sum = 0;
    for (const participant of team) {
      sum += participant.handicap
    }

    return sum;
  }

  function sumOfTeamScore(team) {
    let sumOfScore = 0;
    for (const participant of team) {
      sumOfScore += participant.score;
    }
    return sumOfScore;
  }

  function getKeys() {
    return Array.from( participantMap.keys() ).sort(function (a, b) {
      return a - b;
    });
  }

  function guideRecommendHandicapScore() {
    let guideString = 'ë‹¨ìˆœ ì—ë²„ë¦¬ì§€ í•©ì‚° ì°¨ì´ì— ì˜í•œ í•¸ë””ìº¡ì´ ì•„ë‹Œ, \n'
    guideString += 'í˜„ì‹¤ì ì¸ ìš”ì†Œë¥¼ ë°˜ì˜í•œ í•¸ë””ìº¡ ì ìˆ˜ì…ë‹ˆë‹¤. \n'
    guideString += 'í–¥í›„ì— ë¡œì§ì´ ì¶”ê°€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. \n\n'
    guideString += '1. ì‹œë“œ ë‚´ ëª¨ë“  ë©¤ë²„ê°€ ì—ë²„ë¦¬ì§€ ' + topSeedScore + 'ì´ìƒì¸ ê²½ìš° í•¸ë”” ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n'
    guideString += '2. ê° ì‹œë“œ ë‚´ í‰ê·  ì ìˆ˜ì™€ì˜ ì°¨ì´ë¡œ í•¸ë””ìº¡ ì ìˆ˜ê°€ ê²°ì •ë©ë‹ˆë‹¤.\n'
    guideString += '3. í•¸ë””ìº¡ ì ìˆ˜ëŠ” 1ì˜ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦½ ë©ë‹ˆë‹¤ (-15ì  -> -20ì , 7ì  -> +10ì )\n'
    guideString += '4. íŒ€ì— ë¶€ì¡±í•œ ì¸ì›ì€ ê°€ìƒìœ ì €ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ (ì‹œë“œ ë‚´ ì—ë²„ë¦¬ì§€ì˜ ë°˜ì˜¬ë¦¼ì„ í•¸ë””ë¡œ ì ìš©)\n'
    alert(guideString)
  }

  function shuffle(array) {
    array.sort(() => Math.random() - 0.5);
  }
</script>

<footer class="footer">
    Copyright Â© 2022 NY.KING. All rights reserved.
</footer>

<style>
    button {
        width:110px;
        height:30px;
        font-size:12px;
    }
    footer {
        align-content: center;
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: 60px;
        width: 100%;
        background: grey;
        color: white;
    }
    table, th, td {
        padding: 10px;
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>