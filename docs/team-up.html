version: v1.0.2
<span style="font-size:20px;margin-left: 10px"><b><a href="index.html">ë©”ì¸ìœ¼ë¡œ ì´ë™</a></b></span> <br><br>
<title>ë³¼ì¥ë‚œ íŒ€ ë‚˜ëˆ„ê¸°</title>
<head>
    <link rel="shortcut icon" type="image/x-icon" href="icons/icons.ico">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KPHH0BQLN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2KPHH0BQLN');
    </script>
</head>

<span style="font-size:20px;"><b> - ë³¼ì¥ë‚œ ì „ì²´ ì¸ì› - </b></span><br>
<span style="font-size:15px;color:red"><b>* ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤</b></span><br><br>
<div id="member-div">

</div>
<br><br><br>

<span style="font-size:20px;"><b> - ì •ëª¨ ì°¸ê°€ ì¸ì›: <span id="participant-count-span" style="font-size:20px;color:red">0</span>ëª… - </b></span><br>
<span style="font-size:15px;color:red"><b>* ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì°¸ê°€ì ëª©ë¡ì— ì œê±°ë©ë‹ˆë‹¤</b></span><br><br>
<button style="width:200px;height:50px;font-size:20px;" onclick="clearParticipant()">ì°¸ì—¬ ì¸ì› ì „ì²´ ì‚­ì œ</button><br><br>
<div id="participant-div">

</div>
<br>
<br>
<span style="font-size:20px;"><b> ---------------------------------------------------------- </b></span><br>
<div>
    <span style="width:200px;height:50px;font-size:20px;">
        <select id="team-count-select" style="width:100px;height:50px;font-size:25px;align-content: center">
            <option selected>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
        </select> ê°œ íŒ€ ìœ¼ë¡œ ë‚˜ëˆ„ê¸°
    </span> <br><br>
    <button style="width:200px;height:50px;font-size:20px;" onclick="divideTeam()">íŒ€ ë‚˜ëˆ„ê¸° ì‹¤í–‰</button>
</div>

<br>
<div id="divide-team-div" style="font-size:15px">
</div>

<br><br>
<span style="font-size:20px;"><b> - ì‹œë“œ ë°°ì • - </b></span><br><br>
<div id="group-div">

</div>

<br><br>
<span style="font-size:20px;"><b> - íŒ€ ë°°ì • - </b></span><br><br>
<span style="font-size:15px;color:red"><b>* í¸ì°¨ì— ëŒ€í•œ ë°˜ì˜¬ë¦¼ ì—°ì‚° ë“±ìœ¼ë¡œ ê²½í—˜ì  ì§ê´€ìœ¼ë¡œ íŒë‹¨í–ˆì„ ë•Œ ìë™ ê³„ì‚°ëœ í•¸ë”” ì ìˆ˜ê°€ ë¹„í•©ë¦¬ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</b></span><br>
<span style="font-size:15px;color:red"><b>* ê·¸ëŸ´ ê²½ìš° ì ì ˆí•˜ê²Œ ì§ì ‘ ì¡°ì •í•´ì„œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤. ì–´ë””ê¹Œì§€ë‚˜ ìë™ ê³„ì‚°ëœ í•¸ë””ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</b></span><br><br>
<div id="team-div">
    <table id="team-table">
        <thead><td></td> <td>íŒ€ í•©ì‚°</td> <td>íŒ€ì›</td> <td>ì¶”ì²œí•¸ë”” <button onclick="guideRecommendHandicapScore()">ì¶”ì²œ í•¸ë””ë€?</button></td></thead>
    </table>
</div>
<script>
  window.onload = initialize()

  const memberList = []
  let groups = []
  const participantMap = new Map();
  const topSeedScore = 180

  function initialize() {
    initializeMember();
  }

  function initializeMember() {

    const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/average?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

    fetch(spreadSheetUrl, null)
      .then((response) => response.json())
      .then((data) => initializeMemberMap(data["values"]))
      .catch((error) => console.log("error:", error));
  }

  function initializeMemberMap(values) {
    values = values.sort((a, b) => a[0] < b[0] ? -1 : a[0] > b[0] ? 1 : 0 )

    for (let index = 0; index < values.length; index++) {
      let name = getNohyooKingValue(values[index][0])
      let member = {}
      member.id = index
      member.name = name
      member.score = parseInt(values[index][1])
      member.tier = parseInt(values[index][2])
      member.handicap = 0
      memberList.push(member)
    }
    initializeMemberView()
  }

  function getNohyooKingValue(name) {
    return name === "ë…¸ìœ í•œ" ? "ë…¸ìœ ğŸ‘‘" :  name
  }

  function initializeMemberView() {
    const memberDiv = document.getElementById("member-div");

    let index = 0
    for (const member of memberList) {
      memberDiv.innerHTML += getMemberButtonString(member)
      if ((index+1) % 8 === 0) {
        memberDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function getMemberButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="participateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getParticipateButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="removeParticipateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getMemberNameString(member) {
    return member.name + '(' + member.score + ')';
  }

  function participateMember(memberId) {
    participantMap.set(parseInt(memberId), memberList[memberId])
    updateParticipantView()
  }

  function removeParticipateMember(memberId) {
    participantMap.delete(parseInt(memberId))
    updateParticipantView()
  }

  function clearParticipant() {
    participantMap.clear();
    updateParticipantView()
  }

  function updateParticipantView() {
    const participantDiv = document.getElementById("participant-div");
    const participantCountDiv = document.getElementById("participant-count-span");

    participantDiv.innerHTML = ''

    let index = 0
    let keys = getKeys()

    participantCountDiv.innerText = '' + keys.length

    for (const key of keys) {
      const participant = participantMap.get(key)

      participantDiv.innerHTML += getParticipateButtonString(participant)
      if ((index+1) % 8 === 0) {
        participantDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function divideTeam() {
    const teamCountSelect = document.getElementById('team-count-select');
    const teamCount = parseInt(teamCountSelect.options[teamCountSelect.selectedIndex].value);
    divideGroupAndTeam(teamCount)
  }

  function divideGroupAndTeam(teamCount) {
    let keys = getKeysByOrderByScore()
    groups = []

    for (let keyIndex = 0; keyIndex < keys.length; keyIndex += teamCount) {
      let group = []
      for (let groupCount = 1; groupCount <= teamCount; groupCount++) {
        const participant = participantMap.get(keys[keyIndex+groupCount-1])
        if (participant === undefined) {
          break
        }
        group.push(participant)
      }

      calculateHandicapByTier(group)
        .then(() => groups.push(group))
        .then(() => {
          const groupDiv = document.getElementById("group-div");
          groupDiv.innerHTML = ''

          let groupIndex = 1
          for (const group of groups) {
            groupDiv.innerHTML += getSeedString(groupIndex, group)
            groupIndex++
          }
        })
        .then(() => divideRandomTeam(teamCount))
    }
  }

  function getSeedString(seedNumber, group) {
    let str = ''
    str += seedNumber++ + ' ì‹œë“œ: '
    for (const participant of group) {
      let handicapStr = participant.handicap !== 0 ?'(' + participant.handicap + ')' : ''
      str += participant.name + handicapStr + ' '
    }
    str += '<br>'

    return str
  }

  function calculateHandicap(group) {
    // í•¸ë”” ì¡°ì •

    // ëª¨ë“  ê·¸ë£¹ì´ 180ì  ì´ìƒì¸ ê²½ìš° í•¸ë”” ì¡°ì • ì—†ìŒ
    if (isAllTopSeedMember(group)) {
      for (let participant of group) {
        participant.handicap = 0
      }
      return new Promise(function(resolve) { resolve() });
    }

    const averageOfGroup = sumOfTeamScore(group) / group.length

    let minusHandicapCount = 0;
    for (let participant of group) {
      const diff = participant.score - averageOfGroup
      let handicap = Math.round(diff / 10) * 10 * -1
      participant.handicap = Math.round(diff / 10) * 10 * -1

      if (handicap < 0) {
        minusHandicapCount++
      }
    }

    // ì ˆë°˜ ì´ìƒì´ ë§ˆì´ë„ˆìŠ¤ í•¸ë””ì¸ ê²½ìš° ì „ì²´ í•¸ë”” ì¡°ì •
    if (minusHandicapCount >= group.length / 2) {
      for (let participant of group) {
        if (participant.handicap < 0) {
          let adjustHandicap = participant.handicap * -1
          for (let adjuster of group) {
            adjuster.handicap += adjustHandicap
          }
        }
      }
    }

    return new Promise(function(resolve) { resolve() });
  }

  function calculateHandicapByTier(group) {
    // í•¸ë”” ì¡°ì •

    const highestTier = getHighestTierInGroup(group)
    const highestScoreMember = getHighestScoreMemberInGroup(group)

    group.map(participant => {
      if (participant.tier === 0) {
        participant.handicap = Math.floor((highestScoreMember.score - participant.score) / 10) * 10
        return
      }
      const tierDiff = participant.tier - highestTier
      participant.handicap = tierDiff * 10
    })

    group.map(participant => {
      for (const other of group) {
        if (other.tier !== 0 && other.tier < participant.tier && participant.score > other.score) {
          participant.handicap = other.handicap
        }
      }
    })

    return new Promise(function(resolve) { resolve() });
  }

  function getHighestTierInGroup(group) {
    const excludedZeroTierGroup = group.filter(x => x.tier !== 0)

    if (excludedZeroTierGroup.length === 0) {
      return 0
    }

    return Math.min(...excludedZeroTierGroup.map(x => x.tier))
  }

  function getHighestScoreMemberInGroup(group) {
    return group.reduce((prev, current) => (prev.score > current.score) ? prev : current)
  }

  function isAllTopSeedMember(group) {
    for (let participant of group) {
      if (participant.score < topSeedScore) {
        return false;
      }
    }
    return true;
  }

  function divideRandomTeam(teamCount) {
    let teams = []

    for (const group of groups) {
      shuffle(group);
    }

    for (let count = 0; count < teamCount; count++) {
      let team = []

      for (const group of groups) {
        const averageOfGroup = Math.round((sumOfTeamScore(group) / group.length) / 10) * 10;

        let participant = group[count]
        if (participant === undefined) {
          participant = { "name" : "ê°€ìƒìœ ì €", "score" : 0, "handicap": averageOfGroup }
        }
        team.push(participant)
      }
      teams.push(team)
    }

    const teamTable = document.getElementById("team-table");
    const totalRow = teamTable.getElementsByTagName("tr").length
    for (let index = 1; index < totalRow; index++) {
      teamTable.deleteRow(1)
    }

    let teamIndex = 1
    for (const team of teams) {
      const newRow = teamTable.insertRow(teamIndex)
      newRow.insertCell(0).innerHTML = teamIndex + 'íŒ€'
      newRow.insertCell(1).innerHTML = sumOfTeamScore(team) + 'ì '
      const participantCell = newRow.insertCell(2)
      for (const participant of team) {
        participantCell.innerHTML += participant.name + '(' + getHandicapScoreString(participant.handicap) + ') '
      }
      newRow.insertCell(3).innerHTML = getHandicapScoreString(sumOfHandicap(team)) + 'ì '

      teamIndex++
    }
  }

  function getHandicapScoreString(score) {
    if (score > 0) {
      return '+' +  score
    } else {
      return '' +  score
    }
  }

  function sumOfHandicap(team) {
    let sum = 0;
    for (const participant of team) {
      sum += participant.handicap
    }

    return sum;
  }

  function sumOfTeamScore(team) {
    let sumOfScore = 0;
    for (const participant of team) {
      sumOfScore += participant.score;
    }
    return sumOfScore;
  }

  function getKeys() {
    return Array.from( participantMap.keys() ).sort(function (a, b) {
      return a - b;
    });
  }

  function getKeysByOrderByScore() {
    return Array.from(participantMap).sort((a, b) => b[1].score - a[1].score).map(member => member[1].id)
  }

  function guideRecommendHandicapScore() {
    let guideString = 'ë³¼ì¥ë‚œ í‹°ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í•¸ë”” ì ìˆ˜ì…ë‹ˆë‹¤. \n'
    guideString += 'ë³¼ì¥ë‚œ í‹°ì–´ëŠ” ì ìˆ˜ êµ¬ê°„ê³¼ 200ì  ì´ìƒ ì ìˆ˜ ë¹ˆë„ ë“±ì„ ê³ ë ¤í•©ë‹ˆë‹¤. \n'
    guideString += '1. í‹°ì–´ì°¨ì´ 1ë‹¹ 10ì ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.\n'
    guideString += '2. ê° ì‹œë“œì˜ ìµœê³  í‹°ì–´ ìœ ì €ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•¸ë””ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.\n'
    guideString += '3. 0í‹°ì–´ëŠ” ì‹œë“œ ë‚´ ìµœê³  ì—ë²„ë¦¬ì§€ì™€ì˜ ì°¨ì—ì„œ "ë²„ë¦¼" ì—°ì‚°í•œ ê°’ì„ í•¸ë””ë¡œ ë¶€ì—¬í•©ë‹ˆë‹¤.\n'
    guideString += '4. íŒ€ì— ë¶€ì¡±í•œ ì¸ì›ì€ ê°€ìƒìœ ì €ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ (ì‹œë“œ ë‚´ ì—ë²„ë¦¬ì§€ì˜ ë°˜ì˜¬ë¦¼ì„ í•¸ë””ë¡œ ì ìš©)\n'
    alert(guideString)
  }

  function shuffle(array) {
    array.sort(() => Math.random() - 0.5);
  }
</script>

<footer class="footer">
    Copyright Â© 2022 NY.KING. All rights reserved.
</footer>

<style>
    button {
        width:110px;
        height:30px;
        font-size:12px;
    }
    footer {
        align-content: center;
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: 60px;
        width: 100%;
        background: grey;
        color: white;
    }
    table, th, td {
        padding: 10px;
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>