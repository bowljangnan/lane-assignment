version: v1.0.1 <br><br>
<title>볼장난 팀 나누기</title>

<span style="font-size:20px;"><b> - 볼장난 전체 인원 - </b></span><br>
<span style="font-size:15px;color:red"><b>* 버튼을 누르면 참가자 목록에 추가됩니다</b></span><br><br>
<div id="member-div">

</div>
<br><br><br>

<span style="font-size:20px;"><b> - 정모 참가 인원: <span id="participant-count-span" style="font-size:20px;color:red">0</span>명 - </b></span><br>
<span style="font-size:15px;color:red"><b>* 버튼을 누르면 참가자 목록에 제거됩니다</b></span><br><br>
<button style="width:200px;height:50px;font-size:20px;" onclick="clearParticipant()">참여 인원 전체 삭제</button><br><br>
<div id="participant-div">

</div>
<br>
<br>
<span style="font-size:20px;"><b> ---------------------------------------------------------- </b></span><br>
<div>
    <span style="width:200px;height:50px;font-size:20px;">
        <select id="team-count-select" style="width:100px;height:50px;font-size:25px;align-content: center">
            <option selected>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
        </select> 개 팀 으로 나누기
    </span> <br><br>
    <button style="width:200px;height:50px;font-size:20px;" onclick="divideTeam()">팀 나누기 실행</button>
</div>

<br>
<div id="divide-team-div" style="font-size:15px">
</div>

<br><br>
<span style="font-size:20px;"><b> - 시드 배정 - </b></span><br><br>
<div id="group-div">

</div>

<br><br>
<span style="font-size:20px;"><b> - 팀 배정 - </b></span><br><br>
<div id="team-div">
    <table id="team-table">
        <thead><td></td> <td>팀 합산</td> <td>팀원</td> <td>추천핸디 <button onclick="guideRecommendHandicapScore()">추천 핸디란?</button></td></thead>
    </table>

</div>
<script>
  window.onload = initialize()

  const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/average?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'
  const memberList = []
  let groups = []
  const participantMap = new Map();
  const topSeedScore = 180

  function initialize() {
    initializeMember();
  }

  function initializeMember() {


    fetch(spreadSheetUrl, null)
      .then((response) => response.json())
      .then((data) => initializeMemberMap(data["values"]))
      .catch((error) => console.log("error:", error));
  }

  function initializeMemberMap(values) {
    for (let index = 0; index < values.length; index++) {
      let name = getNohyooKingValue(values[index][0])
      memberList.push({ "id": index, "name" : name, "score" : parseInt(values[index][1]), "handicap": 0 })
    }
    initializeMemberView()
  }

  function getNohyooKingValue(name) {
    return name === "노유한" ? "노유👑" :  name
  }

  function initializeMemberView() {
    const memberDiv = document.getElementById("member-div");

    let index = 0
    for (const member of memberList) {
      memberDiv.innerHTML += getMemberButtonString(member)
      if ((index+1) % 8 === 0) {
        memberDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function getMemberButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="participateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getParticipateButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.id + ' onclick="removeParticipateMember(this.id)">' + getMemberNameString(member) + '</button></span>'
  }

  function getMemberNameString(member) {
    return member.name + '(' + member.score + ')';
  }

  function participateMember(memberId) {
    participantMap.set(parseInt(memberId), memberList[memberId])
    updateParticipantView()
  }

  function removeParticipateMember(memberId) {
    participantMap.delete(parseInt(memberId))
    updateParticipantView()
  }

  function clearParticipant() {
    participantMap.clear();
    updateParticipantView()
  }

  function updateParticipantView() {
    const participantDiv = document.getElementById("participant-div");
    const participantCountDiv = document.getElementById("participant-count-span");

    participantDiv.innerHTML = ''

    let index = 0
    let keys = getKeys()

    participantCountDiv.innerText = '' + keys.length

    for (const key of keys) {
      const participant = participantMap.get(key)

      participantDiv.innerHTML += getParticipateButtonString(participant)
      if ((index+1) % 8 === 0) {
        participantDiv.innerHTML+= '<br><br>'
      }
      index++
    }
  }

  function divideTeam() {
    const teamCountSelect = document.getElementById('team-count-select');
    const teamCount = parseInt(teamCountSelect.options[teamCountSelect.selectedIndex].value);
    divideGroupAndTeam(teamCount)
  }

  function divideGroupAndTeam(teamCount) {
    let keys = getKeys()
    groups = []

    for (let keyIndex = 0; keyIndex < keys.length; keyIndex += teamCount) {
      let group = []
      for (let groupCount = 1; groupCount <= teamCount; groupCount++) {
        const participant = participantMap.get(keys[keyIndex+groupCount-1])
        if (participant === undefined) {
          break
        }
        group.push(participant)
      }

      calculateHandicap(group)
        .then(() => groups.push(group))
        .then(() => {
          const groupDiv = document.getElementById("group-div");
          groupDiv.innerHTML = ''

          let groupIndex = 1
          for (const group of groups) {
            groupDiv.innerHTML += getSeedString(groupIndex, group)
            groupIndex++
          }
        })
        .then(() => divideRandomTeam(teamCount))
    }
  }

  function getSeedString(seedNumber, group) {
    let str = ''
    str += seedNumber++ + ' 시드: '
    for (const participant of group) {
      str += participant.name + ' '
    }
    str += '<br>'

    return str
  }

  function calculateHandicap(group) {
    // 핸디 조정

    // 모든 그룹이 180점 이상인 경우 핸디 조정 없음
    if (isAllTopSeedMember(group)) {
      return new Promise(function(resolve) { resolve() });
    }

    const averageOfGroup = sumOfTeamScore(group) / group.length

    for (let participant of group) {
      const diff = participant.score - averageOfGroup
      let handicap = 0
      if (Math.abs(diff) > 10) {
        handicap = Math.round(diff / 10) * 10 * -1
      }

      participant.handicap = handicap
    }

    return new Promise(function(resolve) { resolve() });
  }

  function isAllTopSeedMember(group) {
    for (let participant of group) {
      if (participant.score < topSeedScore) {
        return false;
      }
    }
    return true;
  }

  function divideRandomTeam(teamCount) {
    let teams = []

    for (const group of groups) {
      shuffle(group);
    }

    for (let count = 0; count < teamCount; count++) {
      let team = []

      for (const group of groups) {
        const averageOfGroup = Math.round((sumOfTeamScore(group) / group.length) / 10) * 10;

        let participant = group[count]
        if (participant === undefined) {
          participant = { "name" : "가상유저", "score" : 0, "handicap": averageOfGroup }
        }
        team.push(participant)
      }
      teams.push(team)
    }

    const teamTable = document.getElementById("team-table");
    const totalRow = teamTable.getElementsByTagName("tr").length
    for (let index = 1; index < totalRow; index++) {
      teamTable.deleteRow(1)
    }

    let teamIndex = 1
    for (const team of teams) {
      const newRow = teamTable.insertRow(teamIndex)
      newRow.insertCell(0).innerHTML = teamIndex + '팀'
      newRow.insertCell(1).innerHTML = sumOfTeamScore(team) + '점'
      const participantCell = newRow.insertCell(2)
      for (const participant of team) {
        participantCell.innerHTML += participant.name + '(' + getHandicapScoreString(participant.handicap) + ') '
      }
      newRow.insertCell(3).innerHTML = getHandicapScoreString(sumOfHandicap(team)) + '점'

      teamIndex++
    }
  }

  function getHandicapScoreString(score) {
    if (score > 0) {
      return '+' +  score
    } else {
      return '' +  score
    }
  }

  function sumOfHandicap(team) {
    let sum = 0;
    for (const participant of team) {
      sum += participant.handicap
    }

    return sum;
  }

  function sumOfTeamScore(team) {
    let sumOfScore = 0;
    for (const participant of team) {
      sumOfScore += participant.score;
    }
    return sumOfScore;
  }

  function getKeys() {
    return Array.from( participantMap.keys() ).sort(function (a, b) {
      return a - b;
    });
  }

  function guideRecommendHandicapScore() {
    let guideString = '단순 에버리지 합산 차이에 의한 핸디캡이 아닌, \n'
    guideString += '현실적인 요소를 반영한 핸디캡 점수입니다. \n'
    guideString += '향후에 로직이 추가될 수 있습니다. \n\n'
    guideString += '1. 시드 내 모든 멤버가 에버리지 ' + topSeedScore + '이상인 경우 핸디 점수를 부여하지 않습니다.\n'
    guideString += '2. 각 시드 내 평균 점수와의 차이로 핸디캡 점수가 결정됩니다.\n'
    guideString += '3. 핸디캡 점수는 1의 자리에서 반올립 됩니다 (-15점 -> -20점, 7점 -> +10점)\n'
    guideString += '4. 팀에 부족한 인원은 가상유저로 채워집니다 (시드 내 에버리지의 반올림을 핸디로 적용)\n'
    alert(guideString)
  }

  function shuffle(array) {
    array.sort(() => Math.random() - 0.5);
  }
</script>

<footer class="footer">
    Copyright © 2022 NY.KING. All rights reserved.
</footer>

<style>
    button {
        width:110px;
        height:30px;
        font-size:12px;
    }
    footer {
        align-content: center;
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: 60px;
        width: 100%;
        background: grey;
        color: white;
    }
    table, th, td {
        padding: 10px;
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>