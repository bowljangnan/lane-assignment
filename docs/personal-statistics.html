<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
<title>볼장난 주간 기록 통계 조회</title>
<head>
    <link rel="shortcut icon" type="image/x-icon" href="icons/icons.ico">
    <link rel="stylesheet" type="text/css" href="css/button.css">
    <link rel="stylesheet" type="text/css" href="css/input.css">
    <link rel="stylesheet" type="text/css" href="css/header.css">
    <script src="https://unpkg.com/hangul-js" type="text/javascript"></script>
    <script src="js/common-utils.v1.js" type="text/javascript"></script>
    <script src="js/api-utils.js" type="text/javascript"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KPHH0BQLN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-2KPHH0BQLN');
    </script>

    <!-- Google Tag Manager -->
    <!--    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':-->
    <!--        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],-->
    <!--      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=-->
    <!--      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);-->
    <!--    })(window,document,'script','dataLayer','GTM-T2B8S7R');</script>-->
    <!-- End Google Tag Manager -->
</head>

<header>
    <span>
        <button type="button" class="w-btn-outline w-btn-gray-outline"
                onclick="location.href='index.html'">메인으로 이동</button>
    </span>
</header>

<body>
<span style="font-size:30px;"><b> - 볼장난 전체 인원 - </b></span><br>
<span style="font-size:15px;color:red"><b>* 버튼을 누르면 주간 개인 기록을 조회할 수 있습니다.</b></span><br>
<span style="font-size:15px;color:red"><b>* 올해 게임 기록이 없다면 버튼이 비활성화 됩니다.</b></span><br>
<div style="font-size:30px;margin-bottom: 20px">
    <input id="search-input"
           class="input-search-bar" onchange="initializeMemberView()"
           placeholder="이름을 검색하세요"/>
</div>
<div id="member-div">

</div>

<br><br>
<span style="font-size:30px;"><b> - 개인 주간 기록 조회: <b><span id="name-span"
                                                          style="font-size:30px; color:blue;"></span></b> - </b></span>
<br><br>
<div id="profile-area-div" style="width:1040px;text-align: center; display: none;">
    <div id="profile-div" style="background-image: url(profiles/default.png);
        background-repeat : no-repeat;
        background-size: cover;
        background-position: center;

    width: 250px; height: 250px; margin: 0 auto; border: 1px solid black"
    >
    </div>
    <br>
    <span id="profile-guide-div"
          style="font-size:12px;color:red;"><b>멋있는 프로필 사진으로 변경하고 싶으신가요? 지금 노유👑에게 문의하세요!</b></span>
</div>
<br>
<div id="statistics-div" style="width: 1040px">
    <table id="weekly-statistics-table" style="width:1000px;font-size: 20px">
        <thead>
        <td><b>날짜</b></td>
        <td><b>게임 수</b></td>
        <td><b>에버리지</b></td>
        <td><b>당월 순위</b></td>
        <td><b>당월 최고 점수</b></td>
        <td><b>당월 최저 점수</b></td>
        </thead>
    </table>
    <br><br>
    <div id='chart-div' style="width:1000px;font-size:30px;color:red">
    </div>
</div>
</body>

<script>
    window.onload = initialize()

    let monthlySheets = []
    let perfectMembers = []
    const memberList = []
    let memberViewList = []
    const memberStatistics = new Map()

    const monthlyAverageRank = new Map()

    let scoreDistributionChart
    let participationChart
    let averageChart
    let rankChart
    let allMemberScoreDistributionChart

    let currentSelectedButton

    const userButtonPrefix = 'user_button_'

    async function initialize() {
        await initializeMember();
    }

    async function initializeMember() {

        const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/average?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

        perfectMembers = await getPerfectMembers()

        await fetch(spreadSheetUrl, null)
            .then((response) => response.json())
            .then((data) => initializeMemberMap(data["values"]))
            .then(() => {
                initializeMemberStatistics()
            })
            .catch((error) => console.log("error:", error))

    }

    async function initializeMemberMap(values) {
        for (let index = 0; index < values.length; index++) {
            const member = getMemberObject(values[index], index)
            memberList.push(member)
        }
        memberViewList = memberList.filter(() => true)
        await initializeMemberView()
    }

    async function initializeMemberView() {

        const searchInput = document.getElementById("search-input");

        const keyword = searchInput.value.trim()

        if (keyword === '') {
            memberViewList = memberList.filter(() => true)
        } else {
            memberViewList = memberList.filter((member) => {
                    const cho = Hangul.disassemble(member.name, true).map((cho) => cho[0]).join('')
                    const keywordCho = Hangul.disassemble(keyword).join('')

                    return member.name.includes(keyword) || Hangul.search(cho, keywordCho) >= 0
                }
            )
        }

        const memberDiv = document.getElementById("member-div");
        memberDiv.innerHTML = ''

        let index = 0
        for (const member of memberViewList) {
            memberDiv.innerHTML += getMemberButtonString(member)
            if ((index + 1) % 8 === 0) {
                memberDiv.innerHTML += '<br><br>'
            }
            index++
        }

        await disableUnrecordUserButton()
    }

    // async function initializeMemberStatistics() {
    //
    //   const spreadSheetMetaUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/weekly-sheets?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'
    //
    //   await fetch(spreadSheetMetaUrl, null)
    //     .then((response) => response.json())
    //     .then((data) => {
    //       const sheetNames = data["values"].map((values) => values[0])
    //       initializeNewWeeklyRecords(sheetNames)
    //     })
    // }

    async function initializeMemberStatistics() {
        await initializeMonthlyRecords()
        console.log(memberStatistics)
    }

    function disableUnrecordUserButton() {
        for (const member of memberViewList) {
            const userMap = memberStatistics.get(member.name)
            if (userMap !== undefined && userMap.size !== 0) {
                document.getElementById(userButtonPrefix + member.name).disabled = false;
                document.getElementById(userButtonPrefix + member.name).className = getButtonClass(member)
            }
        }
    }

    // async function initializeWeeklyRecords(weeklySheetDatas) {
    //   for (const weeklySheet of weeklySheetDatas) {
    //
    //     const sheetName = weeklySheet['properties']['title']
    //
    //     const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1RDT4sZx74q2RUPNOhjg3QF2ynJneUMbg6leHteeHTMw/values/' + sheetName + '?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'
    //
    //     await fetch(spreadSheetUrl, null)
    //       .then((response) => response.json())
    //       .then((data) => {
    //           initializeMemberStatisticsMap(sheetName, data["values"])
    //         }
    //       ).catch((error) => console.log("error:", error));
    //
    //   }
    // }

    async function initializeNewWeeklyRecords(sheetNames) {
        const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/weekly-data?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

        await fetch(spreadSheetUrl, null)
            .then((response) => response.json())
            .then((data) => {
                    initializeNewMemberStatisticsMap(sheetNames, data["values"])
                }
            ).catch((error) => console.log("error:", error));
    }

    async function initializeWeeklyRecords() {
        const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/weekly-records?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

        await fetch(spreadSheetUrl, null)
            .then((response) => response.json())
            .then((data) => {
                    initializeNewMemberStatisticsMap(data["values"])
                }
            ).catch((error) => console.log("error:", error));
    }

    async function initializeMonthlyRecords() {
        const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/weekly-records?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

        await fetch(spreadSheetUrl, null)
            .then((response) => response.json())
            .then((data) => {
                    initializeNewMemberStatisticsMap(data["values"])
                }
            ).catch((error) => console.log("error:", error));
    }

    async function initializeNewMemberStatisticsMap(values) {
        if (values === undefined || values.length === 0) {
            return
        }

        await initializeMemberStatisticsMap(values)

        await disableUnrecordUserButton()

        const urlParams = new URLSearchParams(window.location.search);
        const name = convertName(urlParams.get('name'));
        if (name !== null) {
            await showStatistics(name)
        }
    }

    async function initializeMemberStatisticsMap(values) {
        if (values === undefined || values.length === 0 || values[0].length === 0) {
            return
        }

        for (let index = 0; index < values.length; index++) {
            let name = values[index][2]
            if (!memberList.find(member => member.name === name)) continue;

            let monthlyKey = values[index][0].slice(0, values[index][0].lastIndexOf("-"))

            if (!monthlySheets.includes(monthlyKey)) {
                monthlySheets.push(monthlyKey)
                monthlySheets.sort()
            }

            if (!memberStatistics.has(name)) {
                memberStatistics.set(name, new Map())
            }

            const userMap = memberStatistics.get(name)

            for (let valueIndex = 4; valueIndex < values[index].length; valueIndex++) {

                if (!userMap.get(monthlyKey)) {
                    userMap.set(monthlyKey, [])
                }

                const monthlyRecords = userMap.get(monthlyKey)
                const score = parseInt(values[index][valueIndex])
                if (isNaN(score)) {
                    break;
                }

                monthlyRecords.push(parseInt(values[index][valueIndex]))
            }
        }

        for (const key of memberStatistics.keys()) {
            let currentMonthlyKey = ""
            for (const monthlyKey of memberStatistics.get(key).keys()) {
                let member = {}

                if (monthlyAverageRank.get(monthlyKey) === undefined) {
                    monthlyAverageRank.set(monthlyKey, [])
                    currentMonthlyKey = monthlyKey
                }

                const userMonthlyScores = memberStatistics.get(key).get(monthlyKey)
                const monthlyRankList = monthlyAverageRank.get(monthlyKey)

                member.average = 0
                member.name = key
                if (userMonthlyScores !== undefined && userMonthlyScores.length > 0) {
                    member.average = (userMonthlyScores.reduce((a, b) => a + b) / userMonthlyScores.length).toFixed(2)
                }
                monthlyRankList.push(member)
                monthlyRankList.sort((prev, current) => current.average - prev.average)
            }
        }
    }

    function getMemberButtonString(member) {
        // const btnClass = getButtonClass(member)
        return '<span style="padding: 5px;"><button id = ' + userButtonPrefix + member.name + ' name= ' + member.name + ' class="w-btn-disabled w-btn-gray-disabled" onclick="showStatistics(this.name)" disabled>' + getMemberNameString(member) + '</button></span>'
    }

    function getMemberNameString(member) {
        return member.name;
    }

    async function showStatistics(name) {
        gtag('event', '개인 기록 조회 - ' + name, {'event_category': name, 'event_label': name})

        console.log(name + ' vs ' + getRival(name))

        if (currentSelectedButton !== undefined) {
            const member = memberList.find((member) => member.name === currentSelectedButton.name)
            currentSelectedButton.disabled = false
            currentSelectedButton.className = getButtonClass(member)
        }

        const member = memberList.find((member) => member.name === name)

        currentSelectedButton = document.getElementById(userButtonPrefix + name);
        currentSelectedButton.disabled = true
        currentSelectedButton.className = getDisabledButtonClass(member)

        const nameSpan = document.getElementById("name-span");
        nameSpan.innerHTML = name

        const profileDiv = document.getElementById("profile-div");
        const profileAreaDiv = document.getElementById("profile-area-div");

        profileDiv.style.backgroundImage = 'url(profiles/' + name + '.png), url(profiles/default.png)'
        profileAreaDiv.style.display = 'block';

        const statisticsTable = document.getElementById("weekly-statistics-table");
        const totalRow = statisticsTable.getElementsByTagName("tr").length

        for (let index = 1; index < totalRow; index++) {
            statisticsTable.deleteRow(1)
        }

        let teamIndex = 1
        const monthlyMap = memberStatistics.get(name)

        if (monthlyMap === undefined) {
            alert("올해 기록된 월간 기록이 없습니다.")
            return
        }

        for (const monthlyKey of monthlySheets) {
            const scores = monthlyMap.get(monthlyKey)
            if (scores === undefined) {
                continue
            }
            const newRow = statisticsTable.insertRow(teamIndex)
            newRow.insertCell(0).innerHTML = monthlyKey

            let statistics = getMonthlyStatistics(scores)
            newRow.insertCell(1).innerHTML = statistics.gameCount
            newRow.insertCell(2).innerHTML = statistics.average.toFixed(2)
            newRow.insertCell(3).innerHTML = getMonthlyRank(monthlyKey, name) + '위'
            newRow.insertCell(4).innerHTML = statistics.max
            newRow.insertCell(5).innerHTML = statistics.min

            teamIndex++
        }

        const newRow = statisticsTable.insertRow(teamIndex)

        let totalStatistics = getYearlyStatistics(monthlyMap)

        newRow.insertCell(0).innerHTML = "<span style='color:red'><b>전체 통계</b></span>"
        newRow.insertCell(1).innerHTML = "<span style='color:red'><b>" + totalStatistics.count + "</b></span>"
        newRow.insertCell(2).innerHTML = "<span style='color:red'><b>" + totalStatistics.average.toFixed(2) + "</b></span>"
        newRow.insertCell(3).innerHTML = "<span style='color:red'><b>" + getYearlyRank(name) + "위</b></span>"
        newRow.insertCell(4).innerHTML = "<span style='color:red'><b>" + totalStatistics.max + "</b></span>"
        newRow.insertCell(5).innerHTML = "<span style='color:red'><b>" + totalStatistics.min + "</b></span>"

        await drawChart(name)
    }

    function getMonthlyRank(weeklyKey, name) {
        let weeklyMemberRankList = monthlyAverageRank.get(weeklyKey)
        const member = weeklyMemberRankList.find(member => member.name === name)

        if (member === undefined || member.average === 0) {
            return -1
        }

        return weeklyMemberRankList.indexOf(weeklyMemberRankList.find(member => member.name === name)) + 1
    }

    function getYearlyRank(name) {
        const totalRank = []
        for (const memberName of memberStatistics.keys()) {
            let yearlyData = getYearlyStatistics(memberStatistics.get(memberName))
            yearlyData.name = memberName
            totalRank.push(yearlyData)
        }

        totalRank.sort((prev, current) => current.average - prev.average)

        console.log(totalRank)

        return totalRank.indexOf(totalRank.find(member => member.name === name)) + 1
    }

    function getMonthlyStatistics(scores) {
        let maxScore = 0
        let minScore = 300
        let total = 0
        for (const score of scores) {
            total += score

            if (maxScore < score) {
                maxScore = score
            }

            if (minScore > score) {
                minScore = score
            }
        }

        return {
            "average": total / scores.length,
            "max": maxScore,
            "min": minScore,
            "gameCount": scores.length
        }
    }

    function getYearlyStatistics(monthlyMap) {
        let maxScore = 0
        let minScore = 300
        let total = 0
        let count = 0

        for (const monthlyKey of monthlyMap.keys()) {
            const scores = monthlyMap.get(monthlyKey)

            for (const score of scores) {
                total += score

                if (maxScore < score) {
                    maxScore = score
                }

                if (minScore > score) {
                    minScore = score
                }
                count++
            }
        }

        return {
            "total": total,
            "average": total / count,
            "count": count,
            "max": maxScore,
            "min": minScore
        }
    }

    function drawChart(name) {

        if (scoreDistributionChart !== undefined && scoreDistributionChart != null) {
            scoreDistributionChart.destroy();
        }

        if (participationChart !== undefined && participationChart != null) {
            participationChart.destroy();
        }

        if (averageChart !== undefined && averageChart != null) {
            averageChart.destroy();
        }

        if (rankChart !== undefined && rankChart != null) {
            rankChart.destroy();
        }

        if (averageChart !== undefined && averageChart != null) {
            allMemberScoreDistributionChart.destroy();
        }

        const chartDiv = document.getElementById("chart-div");

        chartDiv.innerHTML = ''
        chartDiv.innerHTML += '<canvas id="score-distribution-chart"></canvas><br><br>'
        // chartDiv.innerHTML += '<canvas id="participation-chart"></canvas><br><br>'
        chartDiv.innerHTML += '<canvas id="average-chart"></canvas><br>'
        // chartDiv.innerHTML += '<canvas id="rank-chart"></canvas><br>'
        chartDiv.innerHTML += '<canvas id="all-member-score-distribution-chart"></canvas><br>'

        drawScoreDistributionChart(name)
        // drawParticipationChart(name)
        drawAverageChart(name)
        // drawRankChart(name)
        drawAllMemberScoreDistributionChart(name)
    }

    function drawScoreDistributionChart(name) {
        // 우선 컨텍스트를 가져옵니다.
        let ctx = document.getElementById("score-distribution-chart").getContext('2d');

        scoreDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [
                    "0", "10", "20", "30", "40", "50", "60", "70", "80", "90",
                    "100", "110", "120", "130", "140", "150", "160", "170", "180", "190",
                    "200", "210", "220", "230", "240", "250", "260", "270", "280", "290",
                ],
                datasets: [{
                    label: name + ' 점수 분포',
                    data: getScoreDistributionData(name),
                    backgroundColor: [
                        'rgba(75, 152, 192, 0.2)',
                        'rgba(75, 162, 192, 0.2)',
                        'rgba(75, 172, 192, 0.2)',
                        'rgba(75, 182, 192, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(75, 202, 192, 0.2)',
                        'rgba(75, 212, 192, 0.2)',
                        'rgba(75, 222, 192, 0.2)',
                        'rgba(75, 232, 192, 0.2)',
                        'rgba(75, 242, 192, 0.2)',
                        'rgba(54, 162, 155, 0.2)',
                        'rgba(54, 162, 165, 0.2)',
                        'rgba(54, 162, 175, 0.2)',
                        'rgba(54, 162, 185, 0.2)',
                        'rgba(54, 162, 195, 0.2)',
                        'rgba(54, 162, 205, 0.2)',
                        'rgba(54, 162, 215, 0.2)',
                        'rgba(54, 162, 225, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(54, 162, 245, 0.2)',
                        'rgba(155, 99, 132, 0.2)',
                        'rgba(165, 99, 132, 0.2)',
                        'rgba(175, 99, 132, 0.2)',
                        'rgba(185, 99, 132, 0.2)',
                        'rgba(195, 99, 132, 0.2)',
                        'rgba(205, 99, 132, 0.2)',
                        'rgba(215, 99, 132, 0.2)',
                        'rgba(225, 99, 132, 0.2)',
                        'rgba(235, 99, 132, 0.2)',
                        'rgba(245, 99, 132, 0.2)',
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                        'rgba(255,99,132,1)',
                    ],
                    borderWidth: 1
                },
                ]
            },


            options: {
                title: {
                    display: true,
                    text: '[ ' + name + ' 점수 분포도 ]',
                    fontSize: 25
                },
                maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            stepSize: 1,
                            min: 0
                        }
                    }]
                }
            }
        })
    }

    function drawParticipationChart(name) {
        let ctx = document.getElementById("participation-chart").getContext('2d');

        const colors = getParticipationBarChartColor();

        const labelCount = monthlySheets.length

        participationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlySheets,
                datasets: [
                    {
                        label: '볼장난 전체 평균 게임 수',
                        data: getEntireMemberParticipationResult().entireCount,
                        backgroundColor: colors.totalBackground,
                        // createArrayObject(colors.totalBackground, labelCount),
                        borderColor: colors.totalBorder,
                        //createArrayObject(colors.totalBorder, labelCount),
                        fill: false,
                        lineTension: 0,
                    }, {
                        label: name + ' 게임 수',
                        data: getMonthlyParticipationCountArray(name),
                        backgroundColor: colors.targetBackground,
                        //createArrayObject(colors.targetBackground, labelCount),
                        borderColor: colors.targetBorder,
                        // createArrayObject(colors.targetBorder, labelCount),
                        fill: false,
                        lineTension: 0
                    },
                    // {
                    //   label: '볼장난 주간 게임 수 1위',
                    //   data: getEntireMemberParticipationResult().maxCount,
                    //   backgroundColor: colors.topBackground,
                    //     // createArrayObject(colors.topBackground, labelCount),
                    //   borderColor: colors.topBorder,
                    //     // createArrayObject(colors.topBorder, labelCount),
                    //   fill: false,
                    //   lineTension: 0,
                    // },
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '[ ' + name + ' 게임 수 그래프 ]',
                    fontSize: 25
                },
                maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            stepSize: 5,
                            min: 0
                        }
                    }]
                }
            }
        })
    }

    function drawAverageChart(name) {
        let ctx = document.getElementById("average-chart").getContext('2d');

        const colors = getParticipationBarChartColor();

        average = new Chart(ctx, {
            type: 'line',
            data: {
                labels: getMonthlyLabels(name),
                datasets: [
                    {
                        label: name + ' 에버리지',
                        data: getMonthlyAverage(name),
                        backgroundColor: colors.targetBackground,
                        borderColor: colors.targetBorder,
                        fill: false,
                        lineTension: 0
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '[ ' + name + ' 주간 에버리지 변화 그래프 ]',
                    fontSize: 25
                },
                maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true
                    }],
                    yAxes: [{
                        display: true,
                        ticks: {
                            suggestedMin: 150,
                        }
                    }]
                }
            }
        })
    }

    function drawRankChart(name) {
        let ctx = document.getElementById("rank-chart").getContext('2d');

        const colors = getParticipationBarChartColor();

        average = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlySheets,
                datasets: [{
                    label: name + ' 주간 순위',
                    data: getMontlyRankData(name),
                    backgroundColor: colors.targetBackground,
                    borderColor: colors.targetBorder,
                    fill: false,
                    lineTension: 0
                }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '[ ' + name + ' 주간 순위 변화 그래프 ]',
                    fontSize: 25
                },
                maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true
                    }],
                    yAxes: [{
                        display: true,
                        ticks: {
                            reverse: true,
                            start: 1,
                            min: 1,
                            suggestedMax: 50
                        }
                    }]
                }
            }
        })
    }

    function drawAllMemberScoreDistributionChart(name) {
        // 우선 컨텍스트를 가져옵니다.
        let ctx = document.getElementById("all-member-score-distribution-chart").getContext('2d');
        const targetAverage = getTotalAverageScore(name)
        allMemberScoreDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [
                    "0", "10", "20", "30", "40", "50", "60", "70", "80", "90",
                    "100", "110", "120", "130", "140", "150", "160", "170", "180", "190",
                    "200", "210", "220", "230", "240", "250", "260", "270", "280", "290",
                ],
                datasets: [{
                    label: name + ' 에버리지 포함 구간(' + targetAverage + ')',
                    data: getAllMemberAverageDistributionData(),
                    backgroundColor: getAllMemberAverageChartBackgroundColor(targetAverage),
                    borderColor: getAllMemberAverageChartBorderColor(targetAverage),
                    borderWidth: 1
                },
                ]
            },
            options: {
                title: {
                    display: true,
                    text: '[ 볼장난 전체 멤버 에버리지 분포도 ]',
                    fontSize: 25
                },
                maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            stepSize: 1,
                            min: 0
                        }
                    }]
                }
            }
        })
    }

    function getScoreDistributionData(name) {
        const weeklyMap = memberStatistics.get(name)

        let totalArray = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0
        ]

        for (const weeklyKey of weeklyMap.keys()) {
            const scores = weeklyMap.get(weeklyKey)
            for (const score of scores) {
                totalArray[parseInt(score / 10)] += 1
            }
        }

        return totalArray;
    }

    function getAllMemberAverageDistributionData() {
        let totalArray = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0
        ]

        for (const memberName of memberStatistics.keys()) {
            let count = 0
            let total = 0
            const member = memberStatistics.get(memberName)
            for (const weeklyKey of member.keys()) {
                total += member.get(weeklyKey).reduce((prev, current) => prev + current)
                count += member.get(weeklyKey).length
            }

            totalArray[parseInt((total / count) / 10)] += 1
        }

        return totalArray
    }

    function getParticipationBarChartColor() {

        const participationBarChartColor = {};
        participationBarChartColor.targetBackground = 'rgba(54, 162, 235, 0.2)'
        participationBarChartColor.targetBorder = 'rgba(54, 162, 235, 1)'
        participationBarChartColor.totalBackground = 'rgba(75, 242, 192, 0.2)'
        participationBarChartColor.totalBorder = 'rgba(75, 192, 192, 1)'
        participationBarChartColor.topBackground = 'rgba(245, 99, 132, 0.2)'
        participationBarChartColor.topBorder = 'rgba(255,99,132,1)'

        return participationBarChartColor
    }

    function getAllMemberAverageChartBackgroundColor(targetAverage) {
        let array = ['rgba(245, 99, 132, 0.2)']

        for (let i = 1; i < 30; i++) {
            if (parseInt(targetAverage / 10) === i) {
                array.push('rgba(245, 99, 132, 0.2)')
                continue;
            }
            array.push('rgba(54, 162, 235, 0.2)')
        }
        return array
    }

    function getAllMemberAverageChartBorderColor(targetAverage) {
        let array = ['rgba(255,99,132,1)']
        for (let i = 1; i < 30; i++) {
            if (parseInt(targetAverage / 10) === i) {
                array.push('rgba(255,99,132,1)',)
                continue;
            }
            array.push('rgba(54, 162, 235, 1)')
        }
        return array
    }

    function createArrayObject(obj, count) {
        const array = [];
        for (let i = 0; i < count; i++) {
            array.push(obj);
        }

        return array;
    }

    function getMonthlyParticipationCountArray(name) {

        const array = [];

        for (const monthlySheet of monthlySheets) {
            const scores = memberStatistics.get(name).get(monthlySheet);
            if (scores === undefined) {
                array.push(0)
                continue;
            }
            array.push(scores.length)
        }
        return array;
    }

    function getEntireMemberParticipationResult() {

        const entireArray = []
        const maxArray = []

        const result = {}

        for (const monthlySheet of monthlySheets) {
            let totalCount = 0
            let maxCount = 0
            let totalMemberCount = 0
            for (const name of memberStatistics.keys()) {
                const scores = memberStatistics.get(name).get(monthlySheet)
                if (scores === undefined) {
                    continue
                }
                const count = scores.length
                totalCount += count
                if (count !== 0) {
                    totalMemberCount++
                }

                if (maxCount < count) {
                    maxCount = count
                }
            }
            entireArray.push(parseInt(totalCount / totalMemberCount))
            maxArray.push(maxCount)
        }

        result.entireCount = entireArray
        result.maxCount = maxArray

        return result;
    }

    function getMonthlyAverage(name) {

        const array = [];

        let member = memberStatistics.get(name)

        if (member === undefined) {
            return array
        }

        for (const monthlySheet of monthlySheets) {
            const scores = member.get(monthlySheet)
            if (scores === undefined) {
                continue
            }

            array.push(getAverage(scores))
        }

        return array;
    }

    function getMonthlyLabels(name) {
        const labels = []
        let member = memberStatistics.get(name)

        for (const monthlySheet of monthlySheets) {
            const scores = member.get(monthlySheet)
            if (scores === undefined) {
                continue
            }

            labels.push(monthlySheet)
        }

        return labels

    }

    function getMontlyRankData(name) {

        const array = [];

        let prevRank = 0
        for (const monthlySheet of monthlySheets) {
            const rank = getMonthlyRank(monthlySheet, name)
            if (rank === -1) {
                continue
            }
            prevRank = rank
        }

        for (const monthlySheet of monthlySheets) {
            const rank = getMonthlyRank(monthlySheet, name)
            if (rank === -1) {
                array.push(prevRank)
            } else {
                array.push(getMonthlyRank(monthlySheet, name))
            }
        }

        return array;
    }

    function getTotalAverageScore(name) {

        let total = 0;
        let count = 0;

        for (const monthlySheet of monthlySheets) {
            const scores = memberStatistics.get(name).get(monthlySheet)
            if (scores === undefined) {
                continue
            }
            total += scores.reduce((prev, current) => prev + current)
            count += scores.length
        }
        return (total / count).toFixed(2);
    }

    function getEntireMemberAverageResult() {

        const entireArray = []
        const maxArray = []

        const result = {}

        for (const monthlySheet of monthlySheets) {
            let total = 0
            let memberCount = 0
            let maxAverage = 0
            for (const name of memberStatistics.keys()) {
                const scores = memberStatistics.get(name).get(monthlySheet)
                if (scores === undefined) {
                    continue
                }

                const average = getMonthlyStatistics(scores).average
                if (average !== 0) {
                    total += average
                    memberCount++
                }

                if (maxAverage < average) {
                    maxAverage = average
                }
            }

            if (memberCount !== 0 && total !== 0) {
                entireArray.push((total / memberCount).toFixed(2))
            }

            if (maxAverage !== 0) {
                maxArray.push(maxAverage.toFixed(2))
            }
        }

        result.entireAverage = entireArray
        result.maxAverage = maxArray

        return result;
    }

    function convertName(name) {
        return name === '노유한' ? '노유한' : name
    }

    function getRival(name) {
        let rival
        let maxSimilarity = -1
        for (const other of memberList) {
            if (other.name === name) {
                continue
            }

            let similarity = getAverageSimilarity(name, other.name)
            if (similarity > maxSimilarity) {
                maxSimilarity = similarity
                rival = other.name
            }
        }

        console.log(maxSimilarity)
        return rival
    }

    function getAverageSimilarity(user1, user2) {

        const user1MonthlyAverages = getMonthlyAverage(user1)
        const user2MonthlyAverages = getMonthlyAverage(user2)

        return getEuclideanSimilarity(user1MonthlyAverages, user2MonthlyAverages)
    }

    function getPiersonSimilarity(arrA, arrB) {
        const averageA = getAverage(arrA)
        const averageB = getAverage(arrB)

        const nomalizedA = []
        const nomalizedB = []
        for (let i = 0; i < arrA.length; i++) {
            nomalizedA.push(arrA[i] - 150)
            nomalizedB.push(arrB[i] - 150)
        }

        let sumOfNomalizedA = 0
        let sumOfNomalizedB = 0
        let sumOfProduct = 0

        for (let i = 0; i < nomalizedA.length; i++) {
            sumOfNomalizedA += nomalizedA[i] * nomalizedA[i]
            sumOfNomalizedB += nomalizedB[i] * nomalizedB[i]
            sumOfProduct += nomalizedA[i] * nomalizedB[i]
        }

        return sumOfProduct / (Math.sqrt(sumOfNomalizedA) * Math.sqrt(sumOfNomalizedB))
    }

    function getCosineSimilarity(arrA, arrB) {
        let sumOfNomalizedA = 0
        let sumOfNomalizedB = 0
        let sumOfProduct = 0

        for (let i = 0; i < arrA.length; i++) {
            sumOfNomalizedA += parseInt(arrA[i]) * parseInt(arrA[i])
            sumOfNomalizedB += parseInt(arrB[i]) * parseInt(arrB[i])
            sumOfProduct += parseInt(arrA[i]) * parseInt(arrB[i])
        }

        return sumOfProduct / (Math.sqrt(sumOfNomalizedA) * Math.sqrt(sumOfNomalizedB))
    }

    function getEuclideanSimilarity(arrA, arrB) {
        let sumOfDiff = 0

        for (let i = 0; i < arrA.length; i++) {
            sumOfDiff += Math.pow(parseInt(arrA[i]) - parseInt(arrB[i]), 2)
        }

        return 1 / (sumOfDiff + 1)
    }


    function getAverage(arr) {
        if (arr.length === 0) {
            return 0
        }
        return arr.reduce((a, b) => parseInt(a) + parseInt(b)) / arr.length
    }

</script>

<footer class="footer">
    Copyright © 2022 NY.KING. All rights reserved.
</footer>

<style>
    footer {
        align-content: center;
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: 60px;
        width: 100%;
        background: grey;
        color: white;
    }

    table, th, td {
        padding: 10px;
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>