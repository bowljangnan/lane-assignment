<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

version: v1.0.0 <br><br>
<title>볼장난 주간 기록 통계 조회</title>

<span style="font-size:20px;"><b> - 볼장난 전체 인원 - </b></span><br>
<span style="font-size:15px;color:red"><b>* 버튼을 누르면 주간 개인 기록을 조회할 수 있습니다.</b></span><br>
<span style="font-size:15px;color:red"><b>* 올해 게임 기록이 없다면 버튼이 비활성화 됩니다.</b></span><br><br>
<div style="font-size:20px;margin-bottom: 20px">
    검색: <input id="search-input" style="width:200px;height:30px" onchange="initializeMemberView()"
               placeholder="이름을 검색하세요"/>
</div>
<div id="member-div">

</div>

<br><br>
<span style="font-size:20px;"><b> - 개인 주간 기록 조회: <span id="name-span" style="color:blue"></span> - </b></span>
<br><br>
<div id="statistics-div">
    <table id="weekly-statistics-table" style="width:800px">
        <thead>
        <td>2022년 주간</td>
        <td>게임 수</td>
        <td>평균</td>
        <td>최고 점수</td>
        <td>최저 점수</td>
        <td>게임비</td>
        </thead>
    </table>
    <br><br>
    <div id='chart-div' style="width:800px;font-size:20px;color:red">
    </div>
</div>

<script>
  window.onload = initialize()

  let weeklySheets = []
  const memberList = []
  let memberViewList = []
  const memberStatistics = new Map()

  function initialize() {
    initializeMember();
  }

  function initializeMember() {

    const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1Vh6MyPi5RFYFgmqBa7L6t3Krra2-wXaULc_5XEWoAAY/values/average?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

    fetch(spreadSheetUrl, null)
      .then((response) => response.json())
      .then((data) => initializeMemberMap(data["values"]))
      .then(() => initializeMemberStatistics())
      .catch((error) => console.log("error:", error))
  }

  function initializeMemberMap(values) {
    for (let index = 0; index < values.length; index++) {
      let name = values[index][0]
      memberList.push({"name": name})
    }
    memberViewList = memberList.filter(() => true)

    initializeMemberView()
  }

  function initializeMemberView() {

    const searchInput = document.getElementById("search-input");

    const keyword = searchInput.value.trim()
    console.log(keyword)
    if (keyword === '') {
      memberViewList = memberList.filter(() => true)
    } else {
      memberViewList = memberList.filter((member) => member.name.includes(keyword))
    }

    const memberDiv = document.getElementById("member-div");
    memberDiv.innerHTML = ''

    let index = 0
    for (const member of memberViewList) {
      memberDiv.innerHTML += getMemberButtonString(member)
      if ((index + 1) % 8 === 0) {
        memberDiv.innerHTML += '<br><br>'
      }
      index++
    }
    disableUnrecordUserButton()
  }

  function initializeMemberStatistics(callback) {

    const spreadSheetMetaUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1RDT4sZx74q2RUPNOhjg3QF2ynJneUMbg6leHteeHTMw?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'
    fetch(spreadSheetMetaUrl, null)
      .then((response) => response.json())
      .then((data) => initializeWeeklyRecords(data["sheets"]))

    setTimeout(() => disableUnrecordUserButton(), 1000)

    return new Promise(function (resolve) {
      resolve()
    });
  }

  function disableUnrecordUserButton() {
    for (const memberName of memberViewList) {
      const userMap = memberStatistics.get(memberName.name)
      if (userMap !== undefined && userMap.size !== 0) {
        document.getElementById(memberName.name).disabled = false;
      }
    }
  }

  function initializeWeeklyRecords(weeklySheetDatas) {

    for (const weeklySheet of weeklySheetDatas) {

      const sheetName = weeklySheet['properties']['title']
      weeklySheets.push(sheetName)

      const spreadSheetUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1RDT4sZx74q2RUPNOhjg3QF2ynJneUMbg6leHteeHTMw/values/' + sheetName + '?key=AIzaSyC7Sh_mpcpjyEcnowiGHiwfM8PZbwWHtAY'

      fetch(spreadSheetUrl, null)
        .then((response) => response.json())
        .then((data) => initializeMemberStatisticsMap(sheetName, data["values"]))
        .catch((error) => console.log("error:", error));
    }

    return new Promise(function (resolve) {
      resolve()
    });
  }

  function initializeMemberStatisticsMap(weeklyKey, values) {
    for (let index = 0; index < values.length; index++) {
      let name = values[index][0]

      if (!memberStatistics.has(name)) {
        memberStatistics.set(name, new Map())
      }

      const userMap = memberStatistics.get(name)

      for (let valueIndex = 1; valueIndex < values[index].length; valueIndex++) {

        if (!userMap.get(weeklyKey)) {
          userMap.set(weeklyKey, [])
        }

        const weeklyRecords = userMap.get(weeklyKey)
        const score = parseInt(values[index][valueIndex])
        if (isNaN(score)) {
          continue;
        }
        weeklyRecords.push(parseInt(values[index][valueIndex]))
      }
    }
  }

  function getMemberButtonString(member) {
    return '<span style="padding: 5px;"><button id=' + member.name + ' onclick="showStatistics(this.id)" disabled>' + getMemberNameString(member) + '</button></span>'
  }

  function getMemberNameString(member) {
    return member.name;
  }

  function showStatistics(name) {
    const nameSpan = document.getElementById("name-span");
    nameSpan.innerHTML = name

    const statisticsTable = document.getElementById("weekly-statistics-table");
    const totalRow = statisticsTable.getElementsByTagName("tr").length

    for (let index = 1; index < totalRow; index++) {
      statisticsTable.deleteRow(1)
    }

    let teamIndex = 1
    const weeklyMap = memberStatistics.get(name)

    if (weeklyMap === undefined) {
      alert("올해 기록된 주간 기록이 없습니다.")
      return
    }

    for (const weeklyKey of weeklyMap.keys()) {
      const newRow = statisticsTable.insertRow(teamIndex)
      newRow.insertCell(0).innerHTML = weeklyKey

      const scores = weeklyMap.get(weeklyKey)

      let statistics = getWeeklyStatistics(scores)
      newRow.insertCell(1).innerHTML = statistics.gameCount
      newRow.insertCell(2).innerHTML = statistics.average.toFixed(2)
      newRow.insertCell(3).innerHTML = statistics.max
      newRow.insertCell(4).innerHTML = statistics.min
      newRow.insertCell(5).innerHTML = (statistics.gameCount * 4100).toLocaleString() + "원"

      teamIndex++
    }

    const newRow = statisticsTable.insertRow(teamIndex)

    let totalStatistics = getYearlyStatistics(weeklyMap)

    newRow.insertCell(0).innerHTML = "<span style='color:red'><b>전체 통계</b></span>"
    newRow.insertCell(1).innerHTML = "<span style='color:red'><b>" + totalStatistics.count + "</b></span>"
    newRow.insertCell(2).innerHTML = "<span style='color:red'><b>" + totalStatistics.average.toFixed(2) + "</b></span>"
    newRow.insertCell(3).innerHTML = "<span style='color:red'><b>" + totalStatistics.max + "</b></span>"
    newRow.insertCell(4).innerHTML = "<span style='color:red'><b>" + totalStatistics.min + "</b></span>"
    newRow.insertCell(5).innerHTML = "<span style='color:red'><b>" + (totalStatistics.count * 4100).toLocaleString() + "원</b></span>"

    drawChart(name)
  }

  function getWeeklyStatistics(scores) {
    let maxScore = 0
    let minScore = 300
    let total = 0
    for (const score of scores) {
      total += score

      if (maxScore < score) {
        maxScore = score
      }

      if (minScore > score) {
        minScore = score
      }
    }

    return {
      "average": total / scores.length,
      "max": maxScore,
      "min": minScore,
      "gameCount": scores.length
    }
  }

  function getYearlyStatistics(weeklyMap) {
    let maxScore = 0
    let minScore = 300
    let total = 0
    let count = 0

    for (const weeklyKey of weeklyMap.keys()) {
      const scores = weeklyMap.get(weeklyKey)

      for (const score of scores) {
        total += score

        if (maxScore < score) {
          maxScore = score
        }

        if (minScore > score) {
          minScore = score
        }
        count++
      }
    }

    return {"average": total / count, "count": count, "max": maxScore, "min": minScore}
  }

  function drawChart(name) {
    const chartDiv = document.getElementById("chart-div");
    chartDiv.innerHTML = ''
    chartDiv.innerHTML += '<canvas id="score-distribution-chart"></canvas><br><br>'
    chartDiv.innerHTML += '<canvas id="participation-chart"></canvas>'

    drawScoreDistributionChart(name)
    drawParticipationChart(name)
  }

  function drawParticipationChart(name) {
    let ctx = document.getElementById("participation-chart").getContext('2d');

    const colors = getParticipationBarChartColor();

    const labelCount = weeklySheets.length

    let scoreDistributionChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weeklySheets,
        datasets: [
          {
            label: '볼장난 전체 평균 참여 횟수',
            data: getEntireMemberParticipationResult().entireCount,
            backgroundColor: createArrayObject(colors.totalBackground, labelCount),
            borderColor: createArrayObject(colors.totalBorder, labelCount),
            borderWidth: 1
          }, {
            label: name + ' 참여 횟수',
            data: getWeeklyParticipationCountArray(name),
            backgroundColor: createArrayObject(colors.targetBackground, labelCount),
            borderColor: createArrayObject(colors.targetBorder, labelCount),
            borderWidth: 1
          }, {
            label: '볼장난 참여 횟수 1위',
            data: getEntireMemberParticipationResult().maxCount,
            backgroundColor: createArrayObject(colors.topBackground, labelCount),
            borderColor: createArrayObject(colors.topBorder, labelCount),
            borderWidth: 1
          },
        ]
      },
      options: {
        title: {
          display: true,
          text: name + ' 참여 횟수 막대 그래프'
        },
        maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 5,
              min: 0
            }
          }]
        }
      }
    })
  }

  function drawScoreDistributionChart(name) {
    // 우선 컨텍스트를 가져옵니다.
    let ctx = document.getElementById("score-distribution-chart").getContext('2d');

    let scoreDistributionChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [
          "0", "10", "20", "30", "40", "50", "60", "70", "80", "90",
          "100", "110", "120", "130", "140", "150", "160", "170", "180", "190",
          "200", "210", "220", "230", "240", "250", "260", "270", "280", "290",
        ],
        datasets: [{
          label: name + ' 점수 분포',
          data: getScoreDistributionData(name),
          backgroundColor: [
            'rgba(75, 152, 192, 0.2)',
            'rgba(75, 162, 192, 0.2)',
            'rgba(75, 172, 192, 0.2)',
            'rgba(75, 182, 192, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(75, 202, 192, 0.2)',
            'rgba(75, 212, 192, 0.2)',
            'rgba(75, 222, 192, 0.2)',
            'rgba(75, 232, 192, 0.2)',
            'rgba(75, 242, 192, 0.2)',
            'rgba(54, 162, 155, 0.2)',
            'rgba(54, 162, 165, 0.2)',
            'rgba(54, 162, 175, 0.2)',
            'rgba(54, 162, 185, 0.2)',
            'rgba(54, 162, 195, 0.2)',
            'rgba(54, 162, 205, 0.2)',
            'rgba(54, 162, 215, 0.2)',
            'rgba(54, 162, 225, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(54, 162, 245, 0.2)',
            'rgba(155, 99, 132, 0.2)',
            'rgba(165, 99, 132, 0.2)',
            'rgba(175, 99, 132, 0.2)',
            'rgba(185, 99, 132, 0.2)',
            'rgba(195, 99, 132, 0.2)',
            'rgba(205, 99, 132, 0.2)',
            'rgba(215, 99, 132, 0.2)',
            'rgba(225, 99, 132, 0.2)',
            'rgba(235, 99, 132, 0.2)',
            'rgba(245, 99, 132, 0.2)',
          ],
          borderColor: [
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
            'rgba(255,99,132,1)',
          ],
          borderWidth: 1
        },
        ]
      },
      options: {
        title: {
          display: true,
          text: name + ' 점수 분포도'
        },
        maintainAspectRatio: true, // default value. false일 경우 포함된 div의 크기에 맞춰서 그려짐.
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              stepSize: 1,
              min: 0
            }
          }]
        }
      }
    })
  }

  function getScoreDistributionData(name) {
    const weeklyMap = memberStatistics.get(name)

    let totalArray = [
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    ]

    for (const weeklyKey of weeklyMap.keys()) {
      const scores = weeklyMap.get(weeklyKey)
      for (const score of scores) {
        totalArray[parseInt(score / 10)] += 1
      }
    }

    return totalArray;
  }

  function getParticipationBarChartColor() {

    const participationBarChartColor = {};
    participationBarChartColor.targetBackground = 'rgba(54, 162, 235, 0.2)'
    participationBarChartColor.targetBorder = 'rgba(54, 162, 235, 1)'
    participationBarChartColor.totalBackground = 'rgba(75, 242, 192, 0.2)'
    participationBarChartColor.totalBorder = 'rgba(75, 192, 192, 1)'
    participationBarChartColor.topBackground = 'rgba(245, 99, 132, 0.2)'
    participationBarChartColor.topBorder = 'rgba(255,99,132,1)'

    return participationBarChartColor
  }

  function createArrayObject(obj, count) {
    const array = [];
    for (let i = 0; i < count; i++) {
      array.push(obj);
    }

    return array;
  }

  function getWeeklyParticipationCountArray(name) {

    const array = [];

    for (const weeklySheet of weeklySheets) {
      array.push(memberStatistics.get(name).get(weeklySheet).length)
    }
    return array;
  }

  function getEntireMemberParticipationResult() {

    const entireArray = []
    const maxArray = []

    const result = {}

    for (const weeklySheet of weeklySheets) {
      let totalCount = 0
      let maxCount = 0
      let totalMemberCount = 0
      for (const name of memberStatistics.keys()) {
        const count = memberStatistics.get(name).get(weeklySheet).length
        totalCount += count
        if (count !== 0) {
          totalMemberCount++
        }

        if (maxCount < count) {
          maxCount = count
        }
      }
      entireArray.push(parseInt(totalCount / totalMemberCount))
      maxArray.push(maxCount)
    }

    result.entireCount = entireArray
    result.maxCount = maxArray

    return result;
  }

</script>

<footer class="footer">
    Copyright © 2022 NY.KING. All rights reserved.
</footer>

<style>
    button {
        width: 80px;
        height: 30px;
        font-size: 12px;
    }

    footer {
        align-content: center;
        position: fixed;
        left: 0px;
        bottom: 0px;
        height: 60px;
        width: 100%;
        background: grey;
        color: white;
    }

    table, th, td {
        padding: 10px;
        border: 1px solid black;
        border-collapse: collapse;
    }
</style>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>